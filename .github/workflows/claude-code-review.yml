name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Only run for PRs from trusted contributors (mirrors the filter in claude.yml)
    if: contains(fromJson('["OWNER","MEMBER","COLLABORATOR"]'), github.event.pull_request.author_association)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          plugin_marketplaces: "https://github.com/anthropics/claude-code.git"
          plugins: "code-review@claude-code-plugins"
          show_full_output: "true"
          track_progress: "true"
          # Pre-approve tools used by the code-review skill so no interactive prompts fire.
          # The mcp__github_inline_comment__ prefix triggers that MCP server installation.
          # The /code-review:code-review skill is called directly at the top level
          # (not via a Task sub-agent) because sub-agents do not inherit marketplace plugins.
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://code.claude.com/docs/en/cli-reference for available options
          claude_args: >-
            --json-schema '{"type":"object","properties":{"verdict":{"type":"string","enum":["pass","fail"]},"summary":{"type":"string"}},"required":["verdict","summary"]}'
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh issue view:*),Bash(gh issue list:*),Bash(gh search:*),Task,Read,Glob,Grep"
          prompt: |
            Run /code-review:code-review --comment ${{ github.repository }}/pull/${{ github.event.pull_request.number }}.

            After the review is complete and findings are posted to the PR, output a JSON object
            with "verdict" set to "pass" if there are zero blocking issues or "fail" for any
            blocking issues or inability to complete the review, and "summary" containing the
            complete review summary.

      - name: Gate on missing verdict
        # Fail-closed: if Claude succeeded but emitted no structured output, something went wrong
        if: steps.claude-review.outcome == 'success' && steps.claude-review.outputs.structured_output == ''
        run: |
          echo "Claude succeeded but emitted no structured verdict. Failing closed."
          exit 1

      - name: Gate on review verdict
        # Fail-closed: fail if Claude ran successfully and returned verdict != pass
        if: steps.claude-review.outcome == 'success' && steps.claude-review.outputs.structured_output != '' && fromJSON(steps.claude-review.outputs.structured_output).verdict != 'pass'
        run: |
          echo "Claude found blocking issues. See PR review for details."
          exit 1

      - name: Check review completed
        if: failure() && steps.claude-review.outcome == 'failure'
        run: echo "Claude Code Review action failed to complete. Check logs for details."
